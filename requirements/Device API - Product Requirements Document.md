# Functional Requirements

## 1. Physical Asset Management

These requirements focus on the "Device as a machine" and support journeys related to hardware health, connectivity, and direct interaction.

- [P0] Real-time Physical State Ingestion & Retrieval:
    

- User Journeys: Support Pilot teleoperation and Engineering debugging.
    
- Requirement: Must ingest and expose raw telemetry (GPS, battery, heading), connectivity status (DriveU/MQTT), and hardware status messages.
    

- [P0] Direct Hardware Interaction (Command API):
    

- User Journeys: Customer retrieval of food, Merchant loading, and Pilot troubleshooting.
    
- Requirement: Provide RPCs to send commands to the robot (e.g., SendDeviceCommand for lid open/close, honk, or flash lights).
    

- [P1] Software Lifecycle Management:
    

- User Journeys: MRO Technician repairs and Engineering deployments.
    
- Requirement: Poll and aggregate AWS Greengrass V2 data, including installed software components, versions, and lifecycle states.
    

- [P1] Diagnostic & Health Reporting:
    

- User Journeys: Field Operator (FO) battery swaps and MRO Technician diagnostics.
    
- Requirement: Expose detailed component health (GPS, Camera, PCU, etc.) and historical telemetry for debugging.
    

- [P1] Transient State Management (Unlock Pins):
    

- User Journeys: Merchant loading (Magic Lid/PIN) and Customer food retrieval.
    
- Requirement: Provide RPCs to set, clear, and validate unlock PINs for the robot keypad.
    

## 2. Operational Fleet Management 

These requirements focus on the "Device as an operational asset" and support journeys involving deliveries and business logic.

- [P0] Real-time "Business-Aware" Fleet View:
    

- User Journeys: Dispatch Operator fleet monitoring and General Manager operational review.
    
- Requirement: Aggregate the physical state from the Device API with operational data (Trip ID, Delivery ID, Merchant ID) into a single FleetDevice resource.
    

- We should be able to sort/filter on the following fields: 
    

- Device name
    
- Online / Offline
    
- Has Cargo
    
- Location
    
- Batteries
    
- Components statuses
    

- Component name
    
- State (healthy, degraded, failed)
    

- RobotOperationState
    
- Trip ID
    
- Delivery ID
    
- Demand ID
    
- Merchant ID
    
- Pilot ID
    
- Provider Mapping (to map to Uber/DoorDash vehicle id)
    

- [P0] Operational Lifecycle Orchestration:
    

- User Journeys: Pilot shift/trip management and Dispatch task assignment.
    
- Requirement: Provide RPCs for AssignTrip, UpdateTrip, and UnassignTrip to manage the robot's role in the delivery lifecycle.
    

- [P0] ID Resolution & Partner Integration:
    

- User Journeys: Partner Platform (Uber/DoorDash) delivery tracking and status updates.
    
- Requirement: Maintain and expose ProviderMapping to resolve internal serial numbers to external partner vehicle IDs.
    

- [P1] Enriched Business Event Publishing:
    

- User Journeys: Integrations Service pushing status to DoorDash and Customer receiving arrival notifications.
    
- Requirement: Consume the Device API stream and publish enriched events such as TripStageChanged (e.g., Arrived at Pickup) to RabbitMQ.
    

- [P1] Operational Flag Management:
    

- User Journeys: Operations Support responding to stuck robots or Dispatch managing maintenance.
    
- Requirement: Allow setting and clearing of operational flags (e.g., needs_movement, needs_pickup) that affect robot dispatchability.
    

## 3. Analytics and Performance Tracking

These requirements support the Operations Analyst in maximizing fleet effectiveness.

- [P2] Unavailability & Failure Analysis:
    

- Requirement: The API must provide enough historical data (via GetTelemetry or RobotStateHistory) to categorize why robots were unavailable (e.g., Grounded, Low Battery, No Pilot).
    

- [P2] Delivery Phase Performance:
    

- Requirement: Must track timestamps for all state transitions (JITP, Load, In-Transit, Dropoff) to measure average delivery times and identify bottlenecks.
    

# Non-functional requirements

- [P0] Mission control only needs to hit the one API to retrieve data it needs for the devices page.
    
- [P0] The service should be able to handle the volume of events generated by 10,000 devices.  
    10,000 devices x 6 heartbeats per min = 60,000qpm = 1,000qps
    
- [P0] The API should be available through gRPC and should follow Google AIP design guidelines.
    
- [P0] There should be zero downtime in the migration to this new API since these paths are all actively in use.
    
- [P0] It should be possible to incrementally migrate consumers of the device state to the new device API.
    
- [P0] Out of order events should be handled gracefully. 
    

- Most queue systems guarantee order within a topic, but currently the device’s state is published via multiple topics, which means events can arrive out-of-order (i.e.: heartbeat vs lid events).
    

- [P1] The Device Service’s database is the single source of truth for all device-specific metadata.
    
- [P1] We should be able to validate the new API against the current implementation to verify the correctness of the data.
    

- [P1] The device API should be agnostic of anything related to food deliveries. 
    
- [P1] All data exposed by the current Device Service should be exposed by the new API.
    
- [P1] All data exposed by the State Service should be exposed by the new API.
    
- [P1] All dependencies of existing device SQS queues (device-events-processing, device-state-processing) should be deprecated or replaced with the new API.
    
- [P1] All dependencies to the MQTT-to-Kafka Bridge service will be decommissioned.
    

**