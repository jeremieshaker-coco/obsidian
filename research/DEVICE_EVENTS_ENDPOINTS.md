# Device/Robot State & Command Endpoints

This doc summarizes HTTP endpoints that *change* device/robot state or issue commands, the in-repo callers, and the journey context those calls support. It is intended to complement `DEVICE_EVENTS.md`.

---

## State Service (`service/state`)

| Endpoint                                                                               | Callers (in repo)                                                                                                                                                                                                                                                                                                | Journey-purpose                                                                                                                       |
| -------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| `POST /state/:serial/request-transition`                                               | Field Ops app (`client/field-ops/src/hooks/mutations/useReportBotIssue.ts`), MRO web (`web/mro/src/features/device/modules/robots/api/state/useChangeStateStatus.ts`), Mission Control (`web/mission-control/src/api/robot-state.api.ts`)                                                                        | Ops/FO/MRO changes a robot’s operational state (ground, available, etc.) during issue reporting, maintenance, or readiness workflows. |
| `POST /state/lid-command-sync` <br/>`POST /state/initiate-pin-load` (deprecated alias) | Mission Control (`web/mission-control/src/hooks/useUpdateBotLid.ts`), MRO web (`web/mro/src/features/device/modules/robots/api/commands/useSendLidCommand.ts`), Merchant Fleet (`web/merchant-fleet/src/hooks/useToggleRobotLid.tsx`), Field Ops app (`client/field-ops/src/hooks/mutations/useUpdateBotLid.ts`) | Manually open/close lid for loading, troubleshooting, or recovery flows.                                                              |
| `POST /state/set-route-id`                                                             | Pilot web (experimental) (`web/pilot/src/experimental/lib/route.ts`)                                                                                                                                                                                                                                             | Associate a robot with a route during pilot/teleop flows.                                                                             |
| `POST /state/set-unlock-pin`                                                           | No in-repo caller found                                                                                                                                                                                                                                                                                          | Set a temporary unlock PIN during customer pickup/assist flows.                                                                       |
| `POST /state/remove-unlock-pin`                                                        | No in-repo caller found                                                                                                                                                                                                                                                                                          | Clear the temporary unlock PIN after pickup/assist flows.                                                                             |
| `GET /state/:serial/current`                                                           | MRO web (`web/mro/src/features/device/modules/robots/api/state/useRobotState.ts`)                                                                                                                                                                                                                                | Show the robot’s current state in MRO device detail/overview panels.                                                                   |
| `POST /state/history`                                                                  | MRO web (`web/mro/src/features/device/modules/robots/api/state/useRobotStateHistory/useRobotStateHistory.ts`)                                                                                                                                                                                                    | Load state history for audits and troubleshooting in the MRO state timeline.                                                          |
| `GET /connectivity/:serial/overall`                                                    | MRO web (`web/mro/src/features/device/modules/robots/api/state/useRobotConnectivity.ts`), Mission Control (`web/mission-control/src/api/robot-state.api.ts`)                                                                                                                                                      | Display online/offline status for ops monitoring and readiness decisions.                                                             |
| `POST /connectivity/history`                                                           | MRO web (`web/mro/src/features/device/modules/robots/api/state/useRobotConnectivityHistory/useRobotConnectivityHistory.ts`)                                                                                                                                                                                      | Review connectivity dropouts over time while debugging comms issues.                                                                  |

---

## Operations Service (`service/operations`)

| Endpoint                               | Callers (in repo)                                                                                                                                                                                                                                                  | Journey-purpose                                                                                                                |
| -------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------ |
| `POST /fleet-management/check-in-bot`  | Merchant Fleet (`web/merchant-fleet/src/hooks/useCheckInBot.ts`), Mission Control (`web/mission-control/src/features/fleet/hooks/useCheckinRobot.ts`), Field Ops app (`client/field-ops/src/hooks/mutations/useCheckInBot.ts`)                                     | Check a robot into a storage location (end of shift, maintenance handoff, or yard intake).                                     |
| `POST /fleet-management/check-out-bot` | Merchant Fleet (`web/merchant-fleet/src/hooks/useCheckOutBot.ts`)                                                                                                                                                                                                  | Check a robot out of storage (make it available for operations).                                                               |
| `POST /robots/:serial/deploy`          | Mission Control (`web/mission-control/src/api/operations.api.ts`)                                                                                                                                                                                                  | Deploy a robot to a parking lot / active fleet location.                                                                       |
| `POST /robots/deploy`                  | Mission Control (`web/mission-control/src/api/operations.api.ts`)                                                                                                                                                                                                  | Bulk deploy (including grounded robots) for fleet readiness.                                                                   |
| `POST /robots/:serial/open-lid`        | Deliveries service (`service/deliveries/src/modules/delivery/service/delivery.service.ts`)                                                                                                                                                                         | Open a robot lid as part of the delivery load/unload workflow.                                                                 |
| `POST /robots/:serial/undeploy`        | Client reference only (`web/mission-control/src/api/operations.api.ts`); no controller found                                                                                                                                                                       | Intended to remove a robot from deployment; not implemented in this repo.                                                      |
| `GET /robots/:serial`                  | No in-repo caller found                                                                                                                                                                                                                                            | Retrieve one robot record (likely used for direct lookups).                                                                    |
| `GET /robots`                          | Mission Control (`web/mission-control/src/features/fleet/hooks/useBots.ts`, `web/mission-control/src/features/deliveries/hooks/useRobots.ts`, `web/mission-control/src/features/deliveries/hooks/useRobotFleet.ts`), Merchant Fleet (`web/merchant-fleet/src/hooks/useRobots.ts`, `web/merchant-fleet/src/hooks/useLoadRobot.ts`) | Populate fleet lists, merchant yard views, and robot pickers.                                                                  |
| `GET /internal/robots`                 | No in-repo caller found                                                                                                                                                                                                                                            | Internal API-key list of robots for backend-to-backend usage.                                                                  |
| `GET /loadable-robots`                 | QR web (`web/qr/src/services/operations.ts`), Deliveries service (`service/deliveries/src/modules/providers/robot/operations.service.ts`)                                                                                                                          | Identify robots eligible to be loaded during merchant pickup flows.                                                            |
| `GET /robots/:serial/location`         | Field Ops app (`client/field-ops/src/hooks/queries/useRobotLocation.ts`)                                                                                                                                                                                           | Show robot location for field ops navigation and on-site support.                                                              |
| `GET /robots/:serial/on-trip`          | No in-repo caller found                                                                                                                                                                                                                                            | Check if a robot is on a trip to gate actions (e.g., loading or maintenance).                                                  |
| `GET /robots/:serial/ready`            | No in-repo caller found                                                                                                                                                                                                                                            | Check operational readiness before dispatch or deployment.                                                                     |
| `GET /robots/:serial/state`            | No in-repo caller found                                                                                                                                                                                                                                            | Fetch the robot’s current state snapshot for diagnostics.                                                                      |
| `GET /robots/:serial/status`           | No in-repo caller found                                                                                                                                                                                                                                            | Fetch the latest state history entry for diagnostics.                                                                          |

---

## Deliveries Service (`service/deliveries`)

| Endpoint | Callers (in repo) | Journey-purpose |
| --- | --- | --- |
| `POST /delivery/:id/open-lid-for-load` | QR web app (`web/qr/src/services/operations.ts`) | Merchant/loader scans QR to open lid and load a delivery. |
| `GET /delivery/active/robot/:serial` | QR web app (`web/qr/src/services/operations.ts`), Mission Control (`web/mission-control/src/hooks/useRobotIsReserved.ts`) | Determine whether a robot is already reserved or has active deliveries before loading. |

---

## Device Service (`service/device`)

| Endpoint                                                 | Callers (in repo)                                                                                                                                                                                    | Journey-purpose                                                    |
| -------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| `POST /devices/commands/lid`                             | No in-repo caller found                                                                                                                                                                              | Send a lid command directly to a device (manual or integration).   |
| `POST /devices/:serial/sync-commands/lid`                | State service (`service/state/src/state/state.service.ts`)                                                                                                                                           | Open/close lid with state-side context (lid cycle + pin flow).     |
| `POST /devices/:serial/commands/soft-reset`              | Pilot web (`web/pilot/src/hooks/useSendSoftReset.tsx`)                                                                                                                                               | Recover a robot without full power cycle during support triage.    |
| `POST /devices/:serial/commands/modem-reset`             | Pilot web (`web/pilot/src/hooks/useSendModemReset.tsx`)                                                                                                                                              | Reset modem to restore connectivity during support triage.         |
| `POST /devices/:serial/commands/hard-reset`              | Pilot web (`web/pilot/src/hooks/useSendHardReset.tsx`)                                                                                                                                               | Power-cycle robot as a last-resort recovery step.                  |
| `POST /devices/:serial/commands/switch-sim-backup`       | Pilot web (`web/pilot/src/hooks/useSendSwitchSimBackup.tsx`)                                                                                                                                         | Switch cellular SIM for connectivity recovery.                     |
| `POST /devices/:serial/commands/reset-gps`               | Pilot web (`web/pilot/src/hooks/useSendResetGPS.tsx`)                                                                                                                                                | Reset GPS during navigation troubleshooting.                       |
| `POST /devices/:serial/commands/lights`                  | Field Ops app (`client/field-ops/src/hooks/mutations/useUpdateBotLights.ts`)                                                                                                                         | Change lights for visibility/safety during field operations.       |
| `POST /devices/:serial/commands/doordash-load-failure`   | Deliveries service (`service/deliveries/src/modules/deviceless/deviceless.client.ts`)                                                                                                                | Play failure sound when deviceless load fails.                     |
| `POST /devices/:serial/commands/doordash-verify-failure` | Deliveries service (`service/deliveries/src/modules/deviceless/deviceless.client.ts`)                                                                                                                | Play failure sound when PIN verification fails.                    |
| `POST /devices/:serial/webrtc-auth`                      | Field Ops app (`client/field-ops/src/hooks/useLocalControl.ts`)                                                                                                                                      | Start WebRTC auth for local/remote control during troubleshooting. |
| `GET /devices`                                           | MRO web (`web/mro/src/features/device/modules/robots/api/useRobotsList.ts`), Mission Control (`web/mission-control/src/api/device.api.ts`)                                                           | List robots for device/fleet views and filters.                    |
| `GET /devices/:serial`                                   | MRO web (`web/mro/src/features/device/modules/robots/api/useRobotDetails.ts`), Mission Control (`web/mission-control/src/features/device/api/robots/useRobotDetails.ts`)                             | Populate robot detail panels and diagnostics views.                |
| `GET /devices/state/lights`                              | No in-repo caller found                                                                                                                                                                              | Inspect recent lights state during troubleshooting.                |
| `GET /devices/gps/batch`                                 | MRO web (`web/mro/src/features/device/modules/robots/api/useRobotGeolocation.ts`), Mission Control (`web/mission-control/src/api/device.api.ts`)                                                     | Plot robot locations on maps and detail views.                     |
| `GET /devices/state/latest`                              | Mission Control (`web/mission-control/src/features/device/api/robots/useRobotLatestStates.ts`, `web/mission-control/src/api/device.api.ts`)                                                          | Show the most recent device states for monitoring and debugging.   |
| `GET /devices/state/full/latest`                         | No in-repo caller found                                                                                                                                                                              | Retrieve full state payloads for deep debugging.                   |
| `GET /devices/state/raw/latest`                          | MRO web (`web/mro/src/features/device/modules/robots/api/useRobotRawHeartbeat.ts`)                                                                                                                   | View raw telemetry snapshots for analysis.                         |
| `GET /devices/heartbeat/history`                         | MRO web (`web/mro/src/features/device/modules/robots/api/useRobotHeartbeat.ts`, `web/mro/src/features/device/modules/robots/api/useRobotHealth.ts`)                                                  | Review heartbeat timeline and derive health summaries.             |
| `GET /devices/heartbeat/latest`                          | No in-repo caller found                                                                                                                                                                              | Fetch the latest heartbeat for a quick health check.               |
| `GET /devices/commands/responses/latest`                 | MRO web (`web/mro/src/features/device/modules/robots/api/commands/useCommandsResponses.ts`), Mission Control (`web/mission-control/src/features/device/api/robots/commands/useCommandsResponses.ts`) | Show recent command results to confirm actions succeeded.          |
| `GET /devices/commands/requests/latest`                  | MRO web (`web/mro/src/features/device/modules/robots/api/commands/useCommandsRequests.ts`), Mission Control (`web/mission-control/src/features/device/api/robots/commands/useCommandsRequests.ts`)   | Show recent command requests for audit and debugging.              |
| `GET /devices/commands/response`                         | No in-repo caller found                                                                                                                                                                              | Look up a specific command response by request ID.                 |

### Integration variants (API key)
The device service exposes API-key protected endpoints under `POST /integration/devices/...` for external integrations. They mirror the device commands above (e.g., `commands/lid`, `:serial/sync-commands/lid`, `:serial/commands/hard-reset`, `:serial/commands/soft-reset`, `:serial/commands/modem-reset`). No in-repo callers found.

#### Integration read-only endpoints

| Endpoint | Callers (in repo) | Journey-purpose |
| --- | --- | --- |
| `GET /integration/devices/state/latest` | No in-repo caller found | Fetch latest states via integration API. |
| `GET /integration/devices/state/batch` | No in-repo caller found | Fetch latest state for multiple devices via integration API. |
| `GET /integration/devices/commands/responses/latest` | No in-repo caller found | Fetch recent command responses via integration API. |
| `GET /integration/devices/commands/requests/latest` | No in-repo caller found | Fetch recent command requests via integration API. |
| `GET /integration/devices/commands/response` | No in-repo caller found | Fetch a command response by request ID via integration API. |

---

## Notes / Gaps
- If `/robots/:serial/undeploy` exists in a different service or via gateway routing, point me to it and I’ll update this doc.
- Several read endpoints show “No in-repo caller found”; they may be used by external tools or older clients.
