# Producers

| Event | Service | Code Reference | Fields Written | Purpose |
| --- | --- | --- | --- | --- |
| **IoT.Heartbeat** | State Service | [iot-streamer.service.ts:567](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/iot-streamer/iot-streamer.service.ts#L567) | `serial`, `createdAt`, `receivedAt`, `processedAt`, `battery` (soc, isCharging, sn), `location` (errHorz, heading, latitude, longitude, updatedAt), `healthy`, `components`, `operationState` | Publishes aggregated robot heartbeat telemetry every ~10 seconds |
| **IoT.HealthStateChanged** | State Service | [iot-streamer.service.ts:575](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/iot-streamer/iot-streamer.service.ts#L575) | Same as IoT.Heartbeat + routing key with `{serial}.{healthy\|unhealthy}` | Published when robot health status changes (healthy â†” unhealthy) |
| **Robots.StateChange** | State Service | [state-transition.subscriber.ts:66-79](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/state/state-machine/listeners/state-transition.subscriber.ts#L66-L79) | `serial`, `operationState`, `needsMaintenance`, `undergoingMaintenance` | Published on robot state machine transitions (GROUNDED, OFF_DUTY, ON_TRIP, PARKED) |
| **Robots.StateChange** | Operations Service | [robots.service.ts:825-853](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/robots/services/robots.service.ts#L825-L853) | `serial`, `operationState` | When robot is grounded (general or due to assistance request) |
| **Robots.StateChange** | Operations Service | [robot-fleet-management.service.ts:121-336](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/fleet-management/services/robot-fleet-management.service.ts#L121-L336) | `serial`, `operationState` (OFF_DUTY or PARKED) | When robot is undeployed or deployed to parking lot |
| **Robots.StateChange** | Operations Service | [pilot-trips.service.ts:225-265](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/trips/services/pilot-trips.service.ts#L225-L265) | `serial`, `operationState`, `hasFood`, `needsMovement`, `tripType`, `attemptCancellationReason` | When pilot trip starts, is cancelled, or resumes |
| **Robots.StateChange** | Operations Service | [pilot-trips.publisher.ts:137-156](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/trips/publishers/pilot-trips.publisher.ts#L137-L156) | `serial`, `operationState` (PARKED), `tripType` (NONE), `hasFood` (false), `attemptCancellationReason` | When pilot trip completes or is cancelled |
| **Robots.StateChange** | Operations Service | [fo-tasks.service.ts:176-316](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/fo-tasks/fo-tasks.service.ts#L176-L316) | `serial`, `needsMaintenance`, `needsPickup`, `undergoingMaintenance` | When FO tasks are created, scheduled, cancelled, or FO arrives at bot |
| **Robots.StateChange** | Deliveries Service | [robot.service.ts:565-572](https://github.com/cocorobotics/delivery-platform/blob/main/service/deliveries/src/modules/providers/robot/robot.service.ts#L565-L572) | `serial`, `hasFood` (true), `needsMovement` (true), `tripType` (DELIVERY), `operationState` (ON_TRIP), `attemptCancellationReason` | When robot is loaded with food |
| **Robots.StateChange** | Deliveries Service | [delivery.service.ts:1384-1388](https://github.com/cocorobotics/delivery-platform/blob/main/service/deliveries/src/modules/delivery/service/delivery.service.ts#L1384-L1388) | `serial`, `hasFood` (false) | When rescue attempt fails |
| **Robots.Deployment** | Operations Service | [robot-state-change-events-publisher.service.ts:15-21](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/fleet-management/publishers/robot-state-change-events-publisher.service.ts#L15-L21) | `serial`, `operationState`, `location` (id, type, latitude, longitude) | When robot is deployed to a location |
| **Robots.State** | Dispatch Engine | [amqp-publisher.service.ts:65-69](https://github.com/cocorobotics/delivery-platform/blob/main/service/dispatch-engine/src/shared/amqp-publisher.service.ts#L65-L69) | Full robot state snapshot for external providers | Published on supply changes for Fleet Service |
| **Robots.PinEntry** | State Service | [iot-streamer.service.ts:296](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/iot-streamer/iot-streamer.service.ts#L296) | `serial`, `requestId`, `expected`, `entered`, `lidOpened`, `timestamp`, `reason` | When PIN is entered on robot keypad |
| **Robots.LidOpen** | State Service | [iot-streamer.service.ts:301-305](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/iot-streamer/iot-streamer.service.ts#L301-L305) | `serial`, `referenceId`, `timestamp` | When lid opens via magic lid (PIN entry success) |
| **Robots.LidClose** | State Service | [iot-streamer.service.ts:360-365](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/iot-streamer/iot-streamer.service.ts#L360-L365) | `serial`, `referenceId`, `trigger` (PIN_ENTRY_CONFIRM, PIN_ENTRY_ABORT, OTHER, battery_swap), `timestamp` | When lid closes after magic lid flow |
| **LidCycle.Init** | State Service | [lid-cycle.service.ts:232-243](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/lid-cycle/lid-cycle.service.ts#L232-L243) | `deviceId`, `type`, `source`, `reasons`, `referenceId`, `openedAt` | When lid cycle is initiated (lid opened) |
| **LidCycle.Complete** | State Service | [lid-cycle.service.ts:232-243](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/lid-cycle/lid-cycle.service.ts#L232-L243) | `deviceId`, `type`, `source`, `reasons`, `referenceId`, `openedAt`, `closedAt` | When lid cycle completes (lid closed) |
| **LidCycle.Timeout** | State Service | [lid-cycle-timeout.worker.ts:59-60](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/lid-cycle/lid-cycle-timeout.worker.ts#L59-L60) | `deviceId`, `type`, `source`, `reasons`, `referenceId` | When lid remains open past timeout threshold |
| **LidCycle.Interrupt** | State Service | [iot-streamer.service.ts:637](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/iot-streamer/iot-streamer.service.ts#L637) | `deviceId`, `type`, `source` (INTERNAL), `reasons` (BATTERY_SWAP) | When battery swap is detected during lid cycle |
| **State.TransitionCompleted** | State Service | [state-transition.subscriber.ts:50-60](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/state/state-machine/listeners/state-transition.subscriber.ts#L50-L60) | `timestamp`, `serial`, `transition`, `fromState`, `toState`, `request` (id, userId, userEmail, comment) | When robot successfully transitions state |
| **State.TransitionFailed** | State Service | [state-transition.subscriber.ts:99-110](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/state/state-machine/listeners/state-transition.subscriber.ts#L99-L110) | `error`, `timestamp`, `serial`, `transition`, `fromState`, `toState`, `request` | When robot state transition is rejected |
| **State.ConnectivityRawStatusChanged** | State Service | [connectivity-event.handler.ts:175-236](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/connectivity/connectivity-event.handler.ts#L175-L236) | `subSource`, `status`, `rawStatus`, `event`, `prevEvent`, `prevStatus`, `prevRawStatus` | When raw DriveU/IoT connectivity status changes |
| **State.ConnectivityOverallChanged** | State Service | [connectivity-event.handler.ts:158-172](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/connectivity/connectivity-event.handler.ts#L158-L172) | `serial`, `timestamp`, `overall` (overallStatus, sources), `prevOverall` | When aggregated connectivity status changes (online/offline) |

---

# Consumers

| Event | Service | Code Reference | Fields Read | Purpose |
| --- | --- | --- | --- | --- |
| **IoT.Heartbeat** | Operations Service | [iot-heartbeat-handler.ts:18-30](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/robots/handlers/iot-heartbeat-handler.ts#L18-L30) | `serial`, `healthy`, `location`, `battery` | Save bot heartbeat, update Redis cache with health info |
| **IoT.Heartbeat** | Dispatch Engine | [iot-heartbeat.handler.ts:44-90](https://github.com/cocorobotics/delivery-platform/blob/main/service/dispatch-engine/src/modules/eventsink/handlers/iot-heartbeat.handler.ts#L44-L90) | `serial`, `battery.soc`, `healthy`, `location` (latitude, longitude), `operationState`, `receivedAt` | Transform to SupplyEvent, update robot supply cache with location/battery |
| **IoT.Heartbeat** | Trip Monitor | [trip-monitor.handler.ts:19-23](https://github.com/cocorobotics/delivery-platform/blob/main/service/trip-monitor/src/modules/trip-monitor/trip-monitor.handler.ts#L19-L23) | `serial`, `location` (latitude, longitude, errHorz, heading, updatedAt), `operationState` | Update trip trace, recalculate ETA, check for departure/arrival |
| **Robots.StateChange** | State Service | [robot-state.handler.ts:18-29](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/state/robot-state.handler.ts#L18-L29) | `serial`, `needsMaintenance` | Sync needsMaintenance flag from other services |
| **Robots.StateChange** | Operations Service | [robot-state-change-handler.ts:52-68](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/robots/handlers/robot-state-change-handler.ts#L52-L68) | `serial`, `needsMovement`, `hasFood`, `tripType`, `operationState`, `needsMaintenance`, `needsPickup`, `undergoingMaintenance`, `driveable` | Update RobotStateHistory in Operations DB |
| **Robots.StateChange** | Dispatch Engine | [robot-stage-change.handler.ts:100-143](https://github.com/cocorobotics/delivery-platform/blob/main/service/dispatch-engine/src/modules/eventsink/handlers/robot-stage-change.handler.ts#L100-L143) | `serial`, `needsMovement`, `hasFood`, `tripType`, `needsMaintenance`, `needsPickup`, `driveable`, `operationState`, `attemptCancellationReason`, `undergoingMaintenance` | Transform to SupplyEvent, update dispatch planner's robot supply cache |
| **Robots.StateChange** | Fleet Service | [robots_state_change.go:18-306](https://github.com/cocorobotics/coco-services/blob/master/fleet/internal/consumer/legacy_robots_consumer/robots_state_change.go#L18-L306) | `serial`, `hasFood`, `needsMaintenance`, `needsMovement`, `needsPickup`, `undergoingMaintenance`, `operationState`, `tripType`, `attemptCancellationReason`, `driveable`, `location` | Update DynamoDB fleet-robots and fleet-legacy-robot-updates tables |
| **Robots.Deployment** | Dispatch Engine | [robot-stage-change.handler.ts:29-96](https://github.com/cocorobotics/delivery-platform/blob/main/service/dispatch-engine/src/modules/eventsink/handlers/robot-stage-change.handler.ts#L29-L96) | `serial`, `operationState`, `location` (id, type, latitude, longitude) | Add robot to supply, update location |
| **Robots.Deployment** | Fleet Service | [robots_deployment.go:18-115](https://github.com/cocorobotics/coco-services/blob/master/fleet/internal/consumer/legacy_robots_consumer/robots_deployment.go#L18-L115) | `serial`, `operationState`, `location` (id, type, latitude, longitude) | Update DynamoDB with deployment location/type |
| **Robots.State** | Fleet Service | [robots_state.go:18-307](https://github.com/cocorobotics/coco-services/blob/master/fleet/internal/consumer/legacy_robots_consumer/robots_state.go#L18-L307) | `serial`, `activeDemandID`, `hasFood`, `needsMaintenance`, `needsMovement`, `needsPickup`, `tripID`, `undergoingMaintenance`, `operationState`, `tripType`, `attemptCancellationReason`, `driveable`, `location` | Update DynamoDB with full robot state snapshot |
| **Robots.PinEntry** | Deliveries Service | [deviceless.handler.ts:56-63](https://github.com/cocorobotics/delivery-platform/blob/main/service/deliveries/src/modules/deviceless/deviceless.handler.ts#L56-L63) | `serial`, `requestId`, `expected`, `entered`, `lidOpened`, `timestamp`, `reason` | Validate PIN, initiate lid cycle |
| **Robots.LidOpen** | Deliveries Service | [robot.handler.ts:357-368](https://github.com/cocorobotics/delivery-platform/blob/main/service/deliveries/src/modules/providers/robot/robot.handler.ts#L357-L368) | `serial`, `referenceId`, `timestamp` | Start loading timer, track lid open timestamp |
| **Robots.LidClose** | Deliveries Service | [robot.handler.ts:371-398](https://github.com/cocorobotics/delivery-platform/blob/main/service/deliveries/src/modules/providers/robot/robot.handler.ts#L371-L398) | `serial`, `referenceId`, `trigger`, `timestamp` | Load robot if PIN_ENTRY_CONFIRM or OTHER, track lid close timestamp |
| **LidCycle.Complete** | Deliveries Service | [deviceless.handler.ts:27-43](https://github.com/cocorobotics/delivery-platform/blob/main/service/deliveries/src/modules/deviceless/deviceless.handler.ts#L27-L43) | `deviceId`, `type`, `source`, `reasons`, `referenceId` | Attempt load if conditions met (load reason, has referenceId) |
| **LidCycle.Timeout** | Deliveries Service | [deviceless.handler.ts:46-53](https://github.com/cocorobotics/delivery-platform/blob/main/service/deliveries/src/modules/deviceless/deviceless.handler.ts#L46-L53) | `deviceId`, `type` | Log timeout error for pin loads |
| **State.TransitionCompleted** | Operations Service | [robot-state-change-handler.ts:20-32](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/robots/handlers/robot-state-change-handler.ts#L20-L32) | `serial`, `toState`, `request.comment` | Update Redis ephemeral state with robotState and comment |
| **State.ConnectivityOverallChanged** | Operations Service | [robot-state-change-handler.ts:34-49](https://github.com/cocorobotics/delivery-platform/blob/main/service/operations/src/modules/robots/handlers/robot-state-change-handler.ts#L34-L49) | `serial`, `overall.overallStatus` | Update Redis with online/offline connectivity status |
| **State.ConnectivityRawStatusChanged** | State Service | [driveu-status.handler.ts](https://github.com/cocorobotics/delivery-platform/blob/main/service/state/src/driveu/driveu-status.handler.ts) | `subSource`, `status`, `rawStatus`, `event` | Save to DynamoDB for DriveU status tracking |

---